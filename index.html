<!DOCTYPE html>
<html>
  <body>
    <canvas id="myCanvas" width="1000" height="1000" style="border:1px solid #000000;"></canvas> 
    <canvas id="canvas-AK-01" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-01A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-02" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-03" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-04" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-05" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-06" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-07" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-07A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-08" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-08A-23" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-09" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-10" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-11" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-12" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-13" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-14" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-15" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-16" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-17" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-18" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-19" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-20" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-01" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-02" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-02A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-02B" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-03" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-04A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-05A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-06" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-06A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-07" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-08" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-12" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-27" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-106" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-117" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-53" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-32" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-31" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-34" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-35" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AP-44" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-LB" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-JB" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-04A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas- AK-09" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-01-A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-21" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-22" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-23" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-bus1" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-bus2" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-07_1" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-07_2" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-AK-07_3" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
    <canvas id="canvas-" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
  </body>
  <script>
    function warp(x) {
      if (x<0) {
        return -Math.sqrt(Math.abs(x));
      } else {
        return Math.sqrt(x);
      }
    }

    function drawPoint(lon, lat, text) {
      var canvasWidth = 1000;
      var canvasHeight = 1000;
      var canvasScale = 1500*1000;

      // center around (-6.6, 106.8) which is right in the Kebun Raya (Bogor, Indonesia).
      var x = lat - 106.8;
      var y = lon + 6.6;

      var canvasX = (canvasWidth/2)+warp(canvasScale*x);
      var canvasY = (canvasHeight/2)-warp(canvasScale*y);
console.log(canvasX, canvasY);
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      ctx.beginPath();
      ctx.arc(canvasX, canvasY, 5, 0, 2*Math.PI);
      ctx.stroke();
      ctx.font = "10px Arial";
      ctx.fillText(text,canvasX+8,canvasY+4);
    }

    function getJSON(name) {
      return new Promise(resolve => {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', `./build/${name}.json`);
        xhr.onload = function() {
          console.log('resolving');
          resolve(JSON.parse(xhr.responseText));
        }
        xhr.send();
      });
    }

    var points;
    var coords;
    var routeNames = {};

    function drawRoute(routeName, dryRun) {
      var missing = [];
      for (var pointName in points[routeName]) {
        var coords = points[routeName][pointName];
        if (coords[0] == '-6.6') {
          console.log('missing', routeName, pointName);
          missing.push(pointName);
        } else {
          console.log('drawing', routeName, pointName, coords);
          if (!dryRun) {
            drawPoint(parseFloat(coords[0]), parseFloat(coords[1]), pointName);
          }
        }
      }
      return missing;
    }

    function drawAll(dryRun) {
      for (var routeName in points) {
        if (routeName.substring(0, 'AK-'.length) == 'AK-') {
          routeNames[routeName] = drawRoute(routeName, dryRun);
        } else {
          console.log('skipping', routeName);
        }
      }
    }

    function drawSource(lineNo, source, stops) {
      console.log('drawSource', lineNo, source, stops);
    }
    
    // ...
    getJSON('joined').then(data => {
      for (var lineNo in data.routes) {
        for (var source in data.routes[lineNo].stops) {
          drawSource(lineNo, source, data.routes[lineNo].stops[source]);
        }
      }
    }).then(() => {
      return getJSON('stopsPerRoute');
    }).then(gotPoints => {
      points = gotPoints;
      drawAll(true);
      console.log(routeNames);
    });
  </script>
</html>
