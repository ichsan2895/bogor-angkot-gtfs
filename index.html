<!DOCTYPE html>
<html>
  <body>
    <canvas id="myCanvas" width="1000" height="1000" style="border:1px solid #000000;"></canvas> 
<h2>AK-01</h2><canvas id="canvas-AK-01" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-01A</h2><canvas id="canvas-AK-01A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-02</h2><canvas id="canvas-AK-02" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-03</h2><canvas id="canvas-AK-03" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-04</h2><canvas id="canvas-AK-04" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-05</h2><canvas id="canvas-AK-05" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-06</h2><canvas id="canvas-AK-06" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-07</h2><canvas id="canvas-AK-07" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-07A</h2><canvas id="canvas-AK-07A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-08</h2><canvas id="canvas-AK-08" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-08A-23</h2><canvas id="canvas-AK-08A-23" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-09</h2><canvas id="canvas-AK-09" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-10</h2><canvas id="canvas-AK-10" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-11</h2><canvas id="canvas-AK-11" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-12</h2><canvas id="canvas-AK-12" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-13</h2><canvas id="canvas-AK-13" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-14</h2><canvas id="canvas-AK-14" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-15</h2><canvas id="canvas-AK-15" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-16</h2><canvas id="canvas-AK-16" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-17</h2><canvas id="canvas-AK-17" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-18</h2><canvas id="canvas-AK-18" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-19</h2><canvas id="canvas-AK-19" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-20</h2><canvas id="canvas-AK-20" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-01</h2><canvas id="canvas-AP-01" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-02</h2><canvas id="canvas-AP-02" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-02A</h2><canvas id="canvas-AP-02A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-02B</h2><canvas id="canvas-AP-02B" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-03</h2><canvas id="canvas-AP-03" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-04A</h2><canvas id="canvas-AP-04A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-05A</h2><canvas id="canvas-AP-05A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-06</h2><canvas id="canvas-AP-06" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-06A</h2><canvas id="canvas-AP-06A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-07</h2><canvas id="canvas-AP-07" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-08</h2><canvas id="canvas-AP-08" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-12</h2><canvas id="canvas-AP-12" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-27</h2><canvas id="canvas-AP-27" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-106</h2><canvas id="canvas-AP-106" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-117</h2><canvas id="canvas-AP-117" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-53</h2><canvas id="canvas-AP-53" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-32</h2><canvas id="canvas-AP-32" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-31</h2><canvas id="canvas-AP-31" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-34</h2><canvas id="canvas-AP-34" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-35</h2><canvas id="canvas-AP-35" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AP-44</h2><canvas id="canvas-AP-44" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>LB</h2><canvas id="canvas-LB" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>JB</h2><canvas id="canvas-JB" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-04A</h2><canvas id="canvas-AK-04A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2> AK-09</h2><canvas id="canvas- AK-09" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-01-A</h2><canvas id="canvas-AK-01-A" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-21</h2><canvas id="canvas-AK-21" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-22</h2><canvas id="canvas-AK-22" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-23</h2><canvas id="canvas-AK-23" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>bus1</h2><canvas id="canvas-bus1" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>bus2</h2><canvas id="canvas-bus2" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-07_1</h2><canvas id="canvas-AK-07_1" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-07_2</h2><canvas id="canvas-AK-07_2" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2>AK-07_3</h2><canvas id="canvas-AK-07_3" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
<h2></h2><canvas id="canvas-" width="1000" height="1000" style="border:1px solid #000000;"></canvas>
  </body>
  <script>
    function warp(x) {
      if (x<0) {
        return -Math.sqrt(Math.abs(x));
      } else {
        return Math.sqrt(x);
      }
    }


    function toCanvas(lon, lat) {
      var canvasWidth = 1000;
      var canvasHeight = 1000;
      var canvasScale = 1500*1000;

      // center around (-6.6, 106.8) which is right in the Kebun Raya (Bogor, Indonesia).
      var x = parseFloat(lat) - 106.8;
      var y = parseFloat(lon) + 6.6;

      var canvasX = (canvasWidth/2)+warp(canvasScale*x);
      var canvasY = (canvasHeight/2)-warp(canvasScale*y);
      console.log('returning', lon, lat, canvasX, canvasY);
      return [canvasX, canvasY];
    }

    function drawPoint(lon, lat, text) {
      var xy = toCanvas(lon, lat);

      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      ctx.beginPath();
      ctx.arc(xy[0], xy[1], 5, 0, 2*Math.PI);
      ctx.stroke();
      ctx.font = "10px Arial";
      ctx.fillText(text,xy[0]+8,xy[1]+4);
    }

    function getJSON(name) {
      return new Promise(resolve => {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', `./build/${name}.json`);
        xhr.onload = function() {
          console.log('resolving');
          resolve(JSON.parse(xhr.responseText));
        }
        xhr.send();
      });
    }

    var points;
    var coords;
    var routeNames = {};

    function drawRoute(routeName, dryRun) {
      var missing = [];
      for (var pointName in points[routeName]) {
        var coords = points[routeName][pointName];
        if (coords[0] == '-6.6') {
          console.log('missing', routeName, pointName);
          missing.push(pointName);
        } else {
          console.log('drawing', routeName, pointName, coords);
          if (!dryRun) {
            drawPoint(parseFloat(coords[0]), parseFloat(coords[1]), pointName);
          }
        }
      }
      return missing;
    }

    function drawAll(dryRun) {
      for (var routeName in points) {
        if (routeName.substring(0, 'AK-'.length) == 'AK-') {
          routeNames[routeName] = drawRoute(routeName, dryRun);
        } else {
          console.log('skipping', routeName);
        }
      }
    }

    function drawSource(lineNo, source, stops) {
      var filteredStops = [];
      for (var i=0; i<stops.length; i++) {
        if (Array.isArray(stops[i])) {
          filteredStops.push(stops[i]);
        }
      }
      console.log('drawSource', lineNo, source, filteredStops);
      if (filteredStops.length < 2) {
        return;
      }
      var c = document.getElementById(`canvas-${lineNo}`);
      var ctx = c.getContext("2d");
      ctx.strokeStyle = {
        majalah: 'rgb(255,0,0)',
        lovelybogor: 'rgb(0,255,0)',
        kotabogor: 'rgb(0,0,255)',
        enterbogor: 'rgb(0,128,128)',
        'enterbogor-back': 'rgb(128,0,128)',
        '2menit': 'rgb(128,128,0)',
      }[source];
      var startPoint = toCanvas(filteredStops[0][0], filteredStops[0][1]);
      ctx.moveTo(startPoint[0], startPoint[1]);
      console.log('ctx.moveTo', startPoint[0], startPoint[1]);

      for (var i=1; i<filteredStops.length; i++) {
        var toPoint = toCanvas(filteredStops[i][0], filteredStops[i][1]);
        ctx.lineTo(toPoint[0], toPoint[1]);
        console.log('ctx.lineTo',toPoint[0], toPoint[1]);
      }
      ctx.stroke();
    }

    // ...
    getJSON('joined').then(data => {
      for (var lineNo in data.routes) {
        console.log('route', lineNo);
        for (var source in data.routes[lineNo].stops) {
          console.log('source', source, data.routes[lineNo].stops[source]);
          drawSource(lineNo, source, data.routes[lineNo].stops[source].map(stopName => data.coords[stopName]));
        }
      }
    }).then(() => {
      return getJSON('stopsPerRoute');
    }).then(gotPoints => {
      points = gotPoints;
      drawAll(true);
      console.log(routeNames);
    });
  </script>
</html>
