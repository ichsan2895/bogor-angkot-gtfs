<!DOCTYPE html>
<html>
  <body>
    <canvas id="myCanvas" width="1500" height="1500" style="border:1px solid #000000;"></canvas> 
  </body>
  <script>
    var routeColors = {
      'AK-01': 'blue',
      'AK-02': 'orange',
      'AK-03': 'blue',
      'AK-04': 'blue',
      'AK-05': 'lightpurple',
      'AK-06': 'yellow',
      'AK-07': 'lightgrey',
      'AK-08': 'red',
      'AK-09': 'purple',
      'AK-10': 'silver',
      'AK-11': 'brown',
      'AK-12': 'yellow',
      'AK-13': 'orange',
      'AK-14': 'pink',
      'AK-15': 'lightbrown',
      'AK-16': 'lightgrey',
      'AK-17': 'black',
      'AK-18': 'black',
      'AK-19': 'black',
      'AK-20': 'black',
      'AK-21': 'black',
      'AK-22': 'black',
      'AK-23': 'black',
    };

    function warp(x) {
      return x/100;
      //:
      if (x<0) {
        return -Math.sqrt(Math.abs(x));
      } else {
        return Math.sqrt(x);
      }
    }

    function toCanvas(lon, lat) {
      var canvasWidth = 1500;
      var canvasHeight = 1500;
      var canvasScale = 1500*1000;

      // center around (-6.6, 106.8) which is right in the Kebun Raya (Bogor, Indonesia).
      var x = parseFloat(lat) - 106.8;
      var y = parseFloat(lon) + 6.6;

      var centerX = 3.2; // <2 means down, >2 means up
      var centerY = 2.6; // <2 means right, >2 means left
      var canvasX = (canvasWidth/centerX)+warp(canvasScale*x);
      var canvasY = (canvasHeight/centerY)-warp(canvasScale*y);
      console.log('returning', lon, lat, canvasX, canvasY);
      return [canvasX, canvasY];
    }

    function drawPoint(lon, lat, text) {
      var xy = toCanvas(lon, lat);

      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      ctx.beginPath();
      ctx.arc(xy[0], xy[1], 5, 0, 2*Math.PI);
      ctx.stroke();
      ctx.font = "10px Arial";
      ctx.fillText(text,xy[0]+8,xy[1]+4);
    }

    function drawText(lon, lat, text) {
      var xy = toCanvas(lon, lat);

      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      ctx.font = "10px Arial";
      ctx.fillText(text,xy[0],xy[1]);
    }

    function getCSV(name) {
      return new Promise(resolve => {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', `./build/${name}.txt`);
        xhr.onload = function() {
          console.log('resolving', xhr.responseText);
          resolve(xhr.responseText.split('\n').map(line => line.split(',')));
        }
        xhr.send();
      });
    }

    function drawLane(lane) {
      console.log('drawLane', lane);
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      ctx.strokeStyle = routeColors[lane[0]];
      ctx.lineWidth = 3.0;
      ctx.beginPath();
      var startPoint = toCanvas(lane[1], lane[2]);
      ctx.moveTo(startPoint[0], startPoint[1]);
      var toPoint = toCanvas(lane[3], lane[4]);
      ctx.lineTo(toPoint[0], toPoint[1]);
      ctx.stroke();
    }

    // ...
    console.log('fetching stretches');
    getCSV('stretches').then(stretches => {
      console.log('got stretches', stretches);
      for (var lineNo=0; lineNo<stretches.length; lineNo++) {
        drawLane(stretches[lineNo]);
      }
    });
  </script>
</html>
