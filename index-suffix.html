  </body>
  <script>
    function warp(x) {
      return x/100;
      //:
      if (x<0) {
        return -Math.sqrt(Math.abs(x));
      } else {
        return Math.sqrt(x);
      }
    }


    function toCanvas(lon, lat) {
      var canvasWidth = 1000;
      var canvasHeight = 1000;
      var canvasScale = 1500*1000;

      // center around (-6.6, 106.8) which is right in the Kebun Raya (Bogor, Indonesia).
      var x = parseFloat(lat) - 106.8;
      var y = parseFloat(lon) + 6.6;

      var canvasX = (canvasWidth/2)+warp(canvasScale*x);
      var canvasY = (canvasHeight/2)-warp(canvasScale*y);
      console.log('returning', lon, lat, canvasX, canvasY);
      return [canvasX, canvasY];
    }

    function drawPoint(lon, lat, text) {
      var xy = toCanvas(lon, lat);

      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      ctx.beginPath();
      ctx.arc(xy[0], xy[1], 5, 0, 2*Math.PI);
      ctx.stroke();
      ctx.font = "10px Arial";
      ctx.fillText(text,xy[0]+8,xy[1]+4);
    }

    function drawText(lon, lat, text) {
      var xy = toCanvas(lon, lat);

      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");

      ctx.font = "10px Arial";
      ctx.fillText(text,xy[0],xy[1]);
    }

    function getJSON(name) {
      return new Promise(resolve => {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', `./build/${name}.json`);
        xhr.onload = function() {
          console.log('resolving');
          resolve(JSON.parse(xhr.responseText));
        }
        xhr.send();
      });
    }

    var points;
    var coords;
    var routeNames = {};

    function drawRoute(routeName, dryRun) {
      var missing = [];
      for (var pointName in points[routeName]) {
        var coords;
        if (pointName.substring(0, 'll_'.length) === 'll_') {
          var parts = pointName.split('_');
          coords = [parts[1], parts[2]];
        } else {
          coords = points[routeName][pointName];
        }
        if (coords[0] == '-6.6') {
          console.log('missing', routeName, pointName);
          missing.push(pointName);
        } else {
          console.log('drawing', routeName, pointName, coords);
          if (!dryRun) {
            drawPoint(parseFloat(coords[0]), parseFloat(coords[1]), pointName);
          }
        }
      }
      return missing;
    }

    function drawAll(dryRun) {
      for (var routeName in points) {
        if (routeName.substring(0, 'AK-'.length) == 'AK-') {
          routeNames[routeName] = drawRoute(routeName, dryRun);
        } else {
          console.log('skipping', routeName);
        }
      }
    }

    function drawSource(lineNo, source, stops, canvas, color) {
      var filteredStops = [];
      for (var i=0; i<stops.length; i++) {
        if (Array.isArray(stops[i])) {
          filteredStops.push(stops[i]);
        }
      }
      console.log('drawSource', lineNo, source, filteredStops);
      if (filteredStops.length < 2) {
        return;
      }
      var c = document.getElementById(canvas || `canvas-${lineNo}`);
      var ctx = c.getContext("2d");
      ctx.strokeStyle = color || {
        majalah: 'rgb(255,0,0)',
        lovelybogor: 'rgb(0,255,0)',
        kotabogor: 'rgb(0,0,255)',
        enterbogor: 'rgb(0,128,128)',
        'enterbogor-back': 'rgb(128,0,128)',
        '2menit': 'rgb(128,128,0)',
        manual: 'rgb(0,0,0)',
      }[source];
      console.log(ctx.strokeStyle);
      ctx.lineWidth = 3.0;
      ctx.beginPath();
      var startPoint = toCanvas(filteredStops[0][0], filteredStops[0][1]);
      ctx.moveTo(startPoint[0], startPoint[1]);
      console.log('ctx.moveTo', startPoint[0], startPoint[1]);

      for (var i=1; i<filteredStops.length; i++) {
        var toPoint = toCanvas(filteredStops[i][0], filteredStops[i][1]);
        ctx.lineTo(toPoint[0], toPoint[1]);
        console.log('ctx.lineTo',toPoint[0], toPoint[1]);
      }
      ctx.stroke();
    }

    // ...
    getJSON('joined').then(data => {
      for (var lineNo in data.routes) {
        console.log('route', lineNo);
        for (var source in data.routes[lineNo].stops) {
          console.log('source', source, data.routes[lineNo].stops[source]);
          // drawSource(lineNo, source, data.routes[lineNo].stops[source].map(stopName => data.coords[stopName]));
        }
      }
      function drawManual(lineNo, color) {
        drawSource(lineNo, 'manual', data.routes[lineNo].stops.manual.map(stopName => stopName.split('_').slice(1)), 'myCanvas', color);
      }
      drawPoint(-6.5849, 106.8168, 'Das Brot');
      drawText(-6.5890, 106.8168, '05');
      drawText(-6.5890, 106.8062, '08,09');
      drawText(-6.6000, 106.8120, '06');
      drawText(-6.6050, 106.8080, '01,09');
      drawText(-6.6150, 106.8150, '01,09');
      drawText(-6.6250, 106.8180, '01');
      drawText(-6.6078, 106.8055, '06,09');
      drawText(-6.5800, 106.8168, '23');
      drawText(-6.5800, 106.8100, '08');
      drawText(-6.5755, 106.8082, '08');
      drawText(-6.5765, 106.8080, '09');
      drawText(-6.5800, 106.8025, '23');
      drawText(-6.5800, 106.7955, '07');
      drawManual('AK-01', 'lightblue');
      drawManual('AK-02', 'orange');
      drawManual('AK-03', 'blue');
      drawManual('AK-05', 'green');
      drawManual('AK-06', 'yellow');
      drawManual('AK-07', 'silver');
      drawManual('AK-08', 'brown');
      drawManual('AK-09', 'purple');
      drawManual('AK-23', 'silver');
    }).then(() => {
      return getJSON('stopsPerRoute');
    }).then(gotPoints => {
      points = gotPoints;
      // drawAll(true);
      console.log(routeNames);
    });
  </script>
</html>
